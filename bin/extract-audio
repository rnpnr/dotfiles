#!/bin/sh

usage() {
	echo "usage: $0 [-d outdir] [-l lang] file ..."
	exit 1
}

while getopts "d:l" arg; do
	case "${arg}" in
	d) outdir="${OPTARG}" ;;
	l) lang="${OPTARG}" ;;
	*) usage ;;
	esac
done

shift $((OPTIND - 1))

[ $# -gt 0 ] || usage

out="${outdir:-.}"
lang=${lang:-jpn}

[ -d "$out" ] || mkdir -p "$out"

IFS=
for f in $*; do
	t=$(echo $f | cut -d . -f 1)
	newf=$out/$t.opus
	idx=$(ffprobe -of compact=nk=1:s=. -v error \
	      -show_entries stream=index,codec_type:stream_tags=language \
	      $f | \
	      awk -F . '/audio.'$lang'/ { print $2; exit }')

	case $f in
	*.mkv|*.mp4)
		ffmpeg -loglevel error -stats \
		       -i $f -map 0:$idx \
		       -map_metadata -1 \
		       -c libopus -mapping_family 255 \
		       -metadata title=$t \
		       $newf
		;;
	*) ;;
	esac
done
